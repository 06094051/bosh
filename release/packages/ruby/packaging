set -e

RUBY_PREFIX=ruby
RUBYGEMS_PREFIX=rubygems
BUNDLER_PREFIX=bundler

RUBY_VERSION=2.1.2
RUBYGEMS_VERSION=2.3.0
BUNDLER_VERSION=1.6.3

RUBY=$RUBY_PREFIX-$RUBY_VERSION
RUBYGEMS=$RUBYGEMS_PREFIX-$RUBYGEMS_VERSION
BUNDLER=$BUNDLER_PREFIX-$BUNDLER_VERSION

tar xzf ruby/yaml-0.1.5.tar.gz
(
  set -e
  cd yaml-0.1.5
  CFLAGS='-fPIC' ./configure --prefix=${BOSH_INSTALL_TARGET} --disable-shared
  make
  make install
)

tar xzf ruby/$RUBY.tar.gz
(
  set -e
  cd $RUBY
  LDFLAGS="-Wl,-rpath -Wl,${BOSH_INSTALL_TARGET}" CFLAGS='-fPIC' ./configure --prefix=${BOSH_INSTALL_TARGET} --disable-install-doc --with-opt-dir=${BOSH_INSTALL_TARGET}
  make
  make install
)

tar zxvf ruby/$RUBYGEMS.tgz

(
  set -e
  cd $RUBYGEMS

  ${BOSH_INSTALL_TARGET}/bin/ruby setup.rb --no-ri --no-rdoc

  if [[ $? != 0 ]] ; then
    echo "Cannot install rubygems"
    exit 1
  fi
)

${BOSH_INSTALL_TARGET}/bin/gem install ruby/$BUNDLER.gem --local --no-ri --no-rdoc
